- [Dealing with Django migrations in Flyway](#dealing-with-django-migrations-in-flyway)
- [Django is still complaining](#django-is-still-complaining)
  - [Generating Django migration entries for Flyway](#generating-django-migration-entries-for-flyway)

## Dealing with Django migrations in Flyway

This folder contains Django `django.contrib` system migrations for `contenttypes`, `sessions`, `auth`, and `admin` defaults.

You can see a list of the default migrations and their status with:

```sh
docker compose run --rm django-web python manage.py showmigrations
```

SQL was generated by running a command like this with each app + migration while stripping out lines matching `/(BEGIN;|COMMIT;)`.

```sh
docker compose run --rm django-web python manage.py sqlmigrate contenttypes 0001_initial
```

<details>

<summary>Here's a Python script that will prcess `sqlmigrate` output to clean up the SQL.</summary>

```python
from datetime import datetime
import os

BASE_VERSION = os.getenv('BASE_VERSION')
COUNT = os.getenv('MINOR_VERSION')

# the name of a django.contrib app like 'auth'
app = os.getenv('DJANGO_APP')

# the name of the valid migration like '0001_initial'
migration = os.getenv('DJANGO_MIGRATION')

command = [
    "docker", "compose", "run", "--rm", "django-web", "python", "manage.py", "sqlmigrate", app, migration
]

outfile = Path(f"V{BASE_VERSION}.{COUNT}__{APP}__{MIGRATION}.sql")
outpath = Path(".") / "flyway" / "sql" / "django_migrations" / outfile

print(f"\033[2m{' '.join(command)} > {outpath}\033[0m", file=sys.stderr, flush=True)

sql_out = subprocess.run(
    command,
    capture_output=True
)

# flyway manages transactions, so we need to strip Django's txn management
sql_string = sql_out.stdout.decode('utf-8')
filtered_sql = re.sub(r'^(BEGIN;|COMMIT;)\n?', '', sql_string, flags=re.MULTILINE)

with open(outpath, 'w') as outf:
    outf.write(f"-- generated {datetime.now()}\n\n")
    outf.write(filtered_sql)
```

</details>

## Django is still complaining

Django really wants to manage migrations, but that's flyway's job in this project.

If you, for example, add a new Django plugin that wants to manage some database tables, you will have to create a Flyway data migration to write the appropriate entries to the table, `django_migrate`.

If you don't, Django will add warnings to almost all console output, forever.

### Generating Django migration entries for Flyway

To generate the appropriate migrations, we can use `manage.py migrate --fake` command for an application. In this example, we're migrating for [`django-flags`](https://cfpb.github.io/django-flags/).

```sh
docker compose run --rm django-web python manage.py migrate flags --fake
```

Then reading out the `django_migrations` table:

```sh
docker compose run --rm \
    -e PGPASSWORD=postgres \
    db \
    psql -h db -p 5432 -U postgres npd_development \
    -c "select app, name from npd.django_migrations where app = 'flags'"
```

Example output of that query:

```
  app  |                       name
-------+--------------------------------------------------
 flags | 0001_initial
 flags | 0002_auto_20151030_1401
 flags | 0003_flag_hidden
 flags | 0004_remove_flag_hidden
 flags | 0005_flag_enabled_by_default
 flags | 0006_auto_20151217_2003
 flags | 0007_unique_flag_site
 flags | 0008_add_state_conditions
 flags | 0009_migrate_to_conditional_state
 flags | 0010_delete_flag_site_fk
 flags | 0011_migrate_path_data_startswith_to_matches
 flags | 0012_replace_migrations_for_wagtail_independence
 flags | 0013_add_required_field
```

Now we convert that output to a SQL insert statement, with the appropriate schema placeholder:

```sql
INSERT INTO
    ${apiSchema}.django_migrations (app, name, applied)
VALUES
    ('flags', '0001_initial', now()),
    ('flags', '0002_auto_20151030_1401', now()),
    ('flags', '0003_flag_hidden', now()),
    ('flags', '0004_remove_flag_hidden', now()),
    ('flags', '0005_flag_enabled_by_default', now()),
    ('flags', '0006_auto_20151217_2003', now()),
    ('flags', '0007_unique_flag_site', now()),
    ('flags', '0008_add_state_conditions', now()),
    ('flags', '0009_migrate_to_conditional_state', now()),
    ('flags', '0010_delete_flag_site_fk', now()),
    ('flags', '0011_migrate_path_data_startswith_to_matches', now()),
    ('flags', '0012_replace_migrations_for_wagtail_independence', now()),
    ('flags', '0013_add_required_field', now());
```

And add it to a new file with the appropriate Flyway version name in `flyway/sql/django_migrations`.

After flyway migrations are run on a database from scratc, Django should report that the `flags` app migrations have been executed:

```console
$ docker compose run --rm django-web python manage.py showmigrations

...
flags
 [X] 0012_replace_migrations_for_wagtail_independence (11 squashed migrations)
 [X] 0013_add_required_field
...
```